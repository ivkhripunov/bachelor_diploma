\section{Ускорение расчета плотности атмосферы}
\label{sec:Chapter2} \index{Chapter2}

В настоящей работе исследуется возможность ускорения расчета плотности атмосферы c
использованием интерполяционных подходов.

Существует несколько хорошо известных алгоритмов многомерной интерполяции. Полилинейная и
поликубическая интерполяция, а также интерполяция до ближайшего характеризуются низкой
вычислительной сложностью, но малой точностью. 
Компромиссом является интерполяция на узлах Чебышева--Лиссажу \cite{dencker2017}, обеспечивающая
быструю многомерную интерполяцию с сохранением высокой точности. 
Именно этот алгоритм был выбран для интерполяции модели атмосферы.

\subsection{Обзор алгоритма интерполяции}
Первый этап создания интерполянта на узлах Чебышева--Лиссажу заключается в построении 
прямоугольной сетки в $\mathbb{R}^d$. В частном случае это сетка в
околоземном пространстве в координатах $(r, \phi, \lambda, t)$.

Затем для ячейки сетки вычисляется набор точек, являющихся обобщением
узлов Чебышева--Гаусса--Лобатто на $d$--мерное пространство:

\begin{equation*}
    \begin{cases*}
        \mathbf{z_{\mathbf{i}}^{\mathbf{(\mathbf{n})}}} = (z_{i_1}^{n_1}, \dots, z_{i_d}^{n_d}) \\
        z_i^{n} = \cos (i \pi / n)
    \end{cases*}
\end{equation*}

Наборы $\mathbf{i} \in \mathbb{N}^d$ состоят либо лишь из четных, либо только из нечетных чисел, при этом каждое
число не превышает соответствующее число из $\mathbf{n} \in \mathbb{N}^d$, 
состоящего из взаимно простых чисел и определяющего конфигурацию интерполянта.

Эти узлы лежат в точках самопересечения кривых Лиссажу:

\begin{equation*}
    \mathbf{l} = \left(\cos \left( \frac{\pi * p[\mathbf{n}]}{n_1} \right), 
                \dots,\cos \left( \frac{\pi * p[\mathbf{n}]}{n_d} \right) \right),
\end{equation*}
где $p[\mathbf{n}] = \prod_{j=1}^{d} n_j$.

Визуализация узлов и кривых Лиссажу для трехмерного пространства представлена на рис. \ref{fig:chebLis}.

\begin{figure}[h!]
    \centering
    \includegraphics[width=0.5\linewidth]{../images/solution/chebLis.png}
    \captionof{figure}{Узлы Чебышева--Лиссажу в единичном кубе}
    \label{fig:chebLis}
\end{figure}

Теперь необходимо найти d-мерный полином, удовлетворяющий условию интерполяции.

Полиномы Чебышева имеют следующий вид:
\begin{equation*}
    T_{\gamma} (x) = \cos (\gamma \arccos (x))
\end{equation*}

В узлах Чебышева--Лиссажу:
\begin{equation*}
    T_{\gamma} (z^n_i) = \cos \left(\gamma \arccos \left(\cos \left(\frac{i \pi}{n}\right) \right)\right)
     = \cos(\gamma \frac{i \pi}{n}) \equiv \chi_{\gamma}^n (i)
\end{equation*}

Определим d-мерные полиномы Чебышева как:
\begin{equation*}
    T_{\mathbf{\gamma}} = T_{\gamma_1} \cdot \dots \cdot T_{\gamma_d},
\end{equation*}
где $\mathbf{\gamma} \in \mathbb{N}^d_0$.
Они составляют ортогональный базис в d-мерном пространстве полиномов. Аналогично,
\begin{equation*}
    \chi_{\mathbf{\gamma}}^{\mathbf{n}} (\mathbf{i}) = \prod_{j=1}^{d} \cos(\gamma_j \frac{i_j \pi}{n_j})
\end{equation*}
В свою очередь $\chi_{\mathbf{\gamma}}^{\mathbf{n}} (\mathbf{i})$ составляют базис в пространстве
функций $L^2$.

Этот факт дает возможность разложить, функцию $h$, заданную на узлах, по данному базису, чтобы
получить коэффициенты интерполяции:
\begin{equation*}
    \begin{cases*}
        h \approx \sum_{\mathbf{\gamma}} c_{\mathbf{\gamma}} (h) \chi_{\mathbf{\gamma}}^{\mathbf{n}} \\
        c_{\mathbf{\gamma}} (h) = \frac{1}{|| \chi_{\mathbf{\gamma}}^{\mathbf{n}} ||^2}
        \left(h, \chi_{\mathbf{\gamma}}^{\mathbf{n}}\right)
    \end{cases*}
\end{equation*}

Вид базисных функций позволяет последовательно
применить дискретное косинус преобразование к каждой размерности для эффективного подсчета
коэффициентов. 

В результате функция может быть аппроксимирована линейной комбинацией произведений
многочленов Чебышева:
\begin{equation*}
    h \approx \sum_{\mathbf{\gamma}} c_{\gamma} T_\gamma
\end{equation*}

В частном случае интерполяции 4-мерной функции плотности атмосферы
результат интерполяции представим в виде:
\begin{equation*}
    \ln(\rho) \approx \sum_{i,j,k,l}^{n_1, n_2, n_3, n_4} 
    c_{i,j,k,l} T_i(r) T_j(\phi) T_k (\lambda) T_l (t),
\end{equation*}
где $T_\alpha$ -- полином Чебышева степени $\alpha$.

Интерполяция логарифма объяснятся тем фактом, что зависимость убывания
атмосферной плотности с высотой примерно экспоненциальная.

Точность интерполяции определяется количеством ячеек, на которое было разбито пространство
и максимальной степенью полиномов по размерности для каждой ячейки. При построении
интерполянта расчет ячеек независим, что дает возможность вычислять коэффициенты в ячейках
параллельно на нескольких потоках.

Скорость интерполяции зависит от конфигурации интерполянта. Чем больше степени полиномов в
каждой ячейке, тем сильнее увеличивается время подсчета.

\subsection{Тестирование интерполяции}

Проведено тестирование точности различных конфигураций интерполянтов для модели NRLMSISE-00.
Диапазон интерполяции по расстоянию был выбран от 350 до 800 километров, интервал по времени
составил одни сутки. В ходе тестов была использована космическая погода за 11 января 2014 года.
Этот год соответствует высокой солнечной активности, что позволяет протестировать качество
интерполяции в сложных условиях.

Сетка для проверки работы алгоритма состояла из более 1 миллиона точек, равномерно
распределенных по области интерполяции. Для каждого интерполянта измерялась максимальная
ошибка на тестовой сетке, размер и величина ускорения по сравнению с прямым расчетом плотности.

Полный перебор по возможным конфигурациям и количеству ячеек интерполянтов сложен
из-за большого количества вариантов, времени, затрачиваемого на построение каждого интерполянта и
занимаемой памяти. Поэтому поиск подходящих параметров проводился поэтапно.

Учитывая близкую к линейной зависимость логарифма плотности от высоты, для этой координаты
была выбрана наименьшая степень полинома -- 2. В рассмотрении остались наборы 
(2, 3, 5, 7), (2, 3, 7, 5), (2, 5, 3, 7), (2, 5, 7, 3), (2, 7, 3, 5),
(2, 7, 5, 3). Интерполянты для полиномов более
высоких порядков не строились из-за снижения производительности таких конфигураций и
существенного повышения затрат памяти для хранения коэффициентов.

Для каждого набора было зафиксировано количество ячеек по высоте -- 65. Количество ячеек
по широте, долготе и времени варьировалось от 5 до 50. Эмпирически определялось
количество ячеек для достижения точности при заданном разбиении по высоте. Далее
для интерполянта с максимальным числом ячеек по широте, долготе и времени варьировалось
количество ячеек по высоте и определялась точность, достижимая с такими параметрами.

На рисунках \ref{fig:atmo:2357} -- \ref{fig:atmo:2753} представлены зависимости относительной ошибки от количества ячеек по
конкретной координате интерполянта. Для времени фиксировалось
максимальное количество ячеек по остальным координатам. Для долготы и широты
фиксировалось наиболее плотное разбиение по широте и долготе соответственно, а диапазон
соответствует вариации количества ячеек по времени.

% \begin{figure}[htbp]
%     \centering
    
%     % Первая строка
%     \begin{subfigure}[b]{0.48\textwidth}
%         \includegraphics[width=\linewidth]{../images/solution/atmo/2357.png}
%         \caption{Зависимость ошибки от количества ячеек интерполянта для конфигурации (2, 3, 5, 7)}
%         \label{fig:atmo:2357}
%     \end{subfigure}
%     \hfill
%     \begin{subfigure}[b]{0.48\textwidth}
%         \includegraphics[width=\linewidth]{../images/solution/atmo/2375.png}
%         \caption{Зависимость ошибки от количества ячеек интерполянта для конфигурации (2, 3, 7, 5)}
%         \label{fig:atmo:2375}
%     \end{subfigure}
    
%     \vspace{0.5cm} % Вертикальный отступ между строками
    
%     % Вторая строка
%     \begin{subfigure}[b]{0.48\textwidth}
%         \includegraphics[width=\linewidth]{../images/solution/atmo/2537.png}
%         \caption{Зависимость ошибки от количества ячеек интерполянта для конфигурации (2, 5, 3, 7)}
%         \label{fig:atmo:2537}
%     \end{subfigure}
%     \hfill
%     \begin{subfigure}[b]{0.48\textwidth}
%         \includegraphics[width=\linewidth]{../images/solution/atmo/2573.png}
%         \caption{Зависимость ошибки от количества ячеек интерполянта для конфигурации (2, 5, 7, 3)}
%         \label{fig:atmo:2573}
%     \end{subfigure}
    
%     \vspace{0.5cm} % Вертикальный отступ между строками
    
%     % Третья строка
%     \begin{subfigure}[b]{0.48\textwidth}
%         \includegraphics[width=\linewidth]{../images/solution/atmo/2735.png}
%         \caption{Зависимость ошибки от количества ячеек интерполянта для конфигурации (2, 7, 3, 5)}
%         \label{fig:atmo:2735}
%     \end{subfigure}
%     \hfill
%     \begin{subfigure}[b]{0.48\textwidth}
%         \includegraphics[width=\linewidth]{../images/solution/atmo/2753.png}
%         \caption{Зависимость ошибки от количества ячеек интерполянта для конфигурации (2, 7, 5, 3)}
%         \label{fig:atmo:2753}
%     \end{subfigure}
    
%     \label{fig:all_images}
% \end{figure}

\begin{figure}[h!]
    \centering
    \includegraphics[width=\linewidth]{../images/solution/atmo/2357.png}
    \captionof{figure}{Зависимость ошибки от количества ячеек интерполянта для конфигурации (2, 3, 5, 7)}
    \label{fig:atmo:2357}
 \end{figure}

 \begin{figure}[h!]
    \centering
    \includegraphics[width=\linewidth]{../images/solution/atmo/2375.png}
    \captionof{figure}{Зависимость ошибки от количества ячеек интерполянта для конфигурации (2, 3, 7, 5)}
    \label{fig:atmo:2375}
 \end{figure}

 \begin{figure}[h!]
    \centering
    \includegraphics[width=\linewidth]{../images/solution/atmo/2537.png}
    \captionof{figure}{Зависимость ошибки от количества ячеек интерполянта для конфигурации (2, 5, 3, 7)}
    \label{fig:atmo:2537}
 \end{figure}

 \begin{figure}[h!]
    \centering
    \includegraphics[width=\linewidth]{../images/solution/atmo/2573.png}
    \captionof{figure}{Зависимость ошибки от количества ячеек интерполянта для конфигурации (2, 5, 7, 3)}
    \label{fig:atmo:2573}
 \end{figure}

 \begin{figure}[h!]
    \centering
    \includegraphics[width=\linewidth]{../images/solution/atmo/2735.png}
    \captionof{figure}{Зависимость ошибки от количества ячеек интерполянта для конфигурации (2, 7, 3, 5)}
    \label{fig:atmo:2735}
 \end{figure}

 \begin{figure}[h!]
    \centering
    \includegraphics[width=\linewidth]{../images/solution/atmo/2753.png}
    \captionof{figure}{Зависимость ошибки от количества ячеек интерполянта для конфигурации (2, 7, 5, 3)}
    \label{fig:atmo:2753}
 \end{figure}

 Из графиков видно, что максимальная точность интерполянтов в тестах составила $4 \cdot 10^{-4}$.
 По срезам можно определить количество ячеек по каждой координате, которого достаточно для достижения
 предельной точности. Чем больше степень во времени, тем уже диапазон по широте и долготе. Это объясняется тем,
 что для достижения максимальной точности при заданном количестве ячеек по расстоянию
 требуется меньше ячеек по времени. На рисунках \ref{fig:atmo:2357_heatmap} -- \ref{fig:atmo:2753_heatmap} изображены карты
 ошибок для разных конфигураций. Градиент на них направлен вдоль оси, соответствующей
 координате с наименьшей степенью в ячейке.

 \begin{figure}[h!]
    \centering
    \includegraphics[width=0.85\linewidth]{../images/solution/atmo/2357_heatmap.png}
    \captionof{figure}{Карта ошибок для конфигурации (2, 3, 5, 7)}
    \label{fig:atmo:2357_heatmap}
 \end{figure}

 \begin{figure}[h!]
    \centering
    \includegraphics[width=0.85\linewidth]{../images/solution/atmo/2375_heatmap.png}
    \captionof{figure}{Карта ошибок для конфигурации (2, 3, 7, 5)}
    \label{fig:atmo:2375_heatmap}
 \end{figure}

 \begin{figure}[h!]
    \centering
    \includegraphics[width=0.85\linewidth]{../images/solution/atmo/2537_heatmap.png}
    \captionof{figure}{Карта ошибок для конфигурации (2, 5, 3, 7)}
    \label{fig:atmo:2537_heatmap}
 \end{figure}

 \begin{figure}[h!]
    \centering
    \includegraphics[width=0.85\linewidth]{../images/solution/atmo/2573_heatmap.png}
    \captionof{figure}{Карта ошибок для конфигурации (2, 5, 7, 3)}
    \label{fig:atmo:2573_heatmap}
 \end{figure}

 \begin{figure}[h!]
    \centering
    \includegraphics[width=0.85\linewidth]{../images/solution/atmo/2735_heatmap.png}
    \captionof{figure}{Карта ошибок для конфигурации (2, 7, 3, 5)}
    \label{fig:atmo:2735_heatmap}
 \end{figure}

 \begin{figure}[h!]
    \centering
    \includegraphics[width=0.85\linewidth]{../images/solution/atmo/2753_heatmap.png}
    \captionof{figure}{Карта ошибок для конфигурации (2, 7, 5, 3)}
    \label{fig:atmo:2753_heatmap}
 \end{figure}

 \begin{figure}[h!]
    \centering
    \includegraphics[width=\linewidth]{../images/solution/atmo/2357_rho.png}
    \captionof{figure}{Зависимость ошибки от количества ячеек интерполянта по радиусу для конфигурации (2, 3, 5, 7)}
    \label{fig:atmo:2357_rho}
 \end{figure}

 На картах \ref{fig:atmo:2753_latlon} и \ref{fig:atmo:2753_latlon_abs_err} приведено
 распределение плотности и абсолютной ошибки соответственно для интерполянта на высоте 350 километров.
 Использовалась конфигурация (2, 7, 5, 3) с количеством ячеек (65, 50, 50, 50). Темные участки, относящиеся к областям с
 повышенной плотностью, совпадают с участками, на которых интерполяция дает наибольшую абсолютную ошибку.
 В то же время относительная ошибка меняется по области не существенно.
 Темные полосы на рисунке \ref{fig:atmo:2753_latlon_abs_err} возникают на границе ячеек
 по широте и долготе.

 \begin{figure}[h!]
    \centering
    \includegraphics[width=\linewidth]{../images/solution/atmo/2753_latlon_direct_val_heatmap.png}
    \captionof{figure}{Распределение плотности $\rho(\phi, \lambda)$ для конфигурации (2, 7, 5, 3)}
    \label{fig:atmo:2753_latlon}
 \end{figure}

 \begin{figure}[h!]
    \centering
    \includegraphics[width=\linewidth]{../images/solution/atmo/2753_latlon_abs_error_heatmap.png}
    \captionof{figure}{Распределение абсолютной ошибки вычисления плотности для конфигурации (2, 7, 5, 3)}
    \label{fig:atmo:2753_latlon_abs_err}
 \end{figure}

 На основе данных о поточечном строении для каждой конфигурации были подобраны интерполянты, 
 ползволяющие достичь малой ошибки при минимальном размере. 
 Характеристики выбранных интерполянтов представлены в таблице !!!.

\clearpage